import{a as B,b as D,j as t}from"./index-DL5OjzhM.js";import{r as a,L}from"./react-BIszHAjf.js";import{u as K}from"./useAuthRedirect-B0RCc203.js";import{u as Q,e as U,f as G}from"./hook-Cv5GwWh6.js";import{F as n,K as l,B as c,a5 as J,I as r,Q as P,q as S,W,a3 as I,G as H,bl as X,a2 as Y}from"./antd-BlFR_sXc.js";import"./fetchHelper-CULhQwJj.js";import"./useQuery-tBKGEfQS.js";import"./useMutation-CP91P1uQ.js";import"./api-DNcEXNcV.js";const{TextArea:Z}=r,{Option:ee}=S,ce=()=>{K();const{poolType:_}=B(D(["poolType"])),{data:d}=Q(_),[u,f]=a.useState([]),[k,j]=a.useState([]),[i,C]=a.useState(""),[p,V]=a.useState(null),[N,m]=a.useState(!1),[x,g]=a.useState(null),[h]=n.useForm(),F=U(),M=G(),[z,$]=a.useState(20);a.useEffect(()=>{if(d)if(Array.isArray(d.data)){const e=d.data.map(s=>({id:s.id,venue_type:s.venue_type,venue_name:s.venue_name,venue_code:s.venue_code,country:s.country,address:s.address,agent_key:s.agent_key,hosted_machine:s.hosted_machine,miner_type:s.miner_type}));f(e),j(e)}else l.error(`获取场地数据失败: ${d.data.message}`)},[d]),a.useEffect(()=>{let e=u;i&&(e=e.filter(s=>{var o,b;return s.venue_name.includes(i)||((o=s.venue_code)==null?void 0:o.includes(i))||((b=s.address)==null?void 0:b.includes(i))})),p&&(e=e.filter(s=>s.country===p)),j(e)},[i,p,u]);const E=e=>{C(e)},T=e=>{V(e||null)},A=()=>{g(null),h.resetFields(),m(!0)},R=e=>{g(e),h.setFieldsValue(e),m(!0)},O=e=>{I.confirm({title:"确认删除",content:"确定要删除这个场地吗？",onOk:()=>{f(u.filter(s=>s.id!==e)),l.success("删除成功")}})},w=()=>{h.validateFields().then(e=>{if(x){const s=Number(e.hosted_machine);if(isNaN(s)){l.error("hosted_machine 不是有效的数字");return}e.hosted_machine=s,M.mutate(e,{onSuccess:()=>{l.success("更新成功")},onError:o=>{l.error(`更新失败: ${o.message}`)}})}else{const s={id:0,venue_name:e.venue_name,venue_code:e.venue_code,country:e.country,address:e.address,agent_key:e.agent_key,hosted_machine:Number(e.hosted_machine),miner_type:e.miner_type};F.mutate({poolType:_,data:s},{onSuccess:()=>{l.success("创建成功")},onError:o=>{l.error(`创建失败: ${o.message}`)}})}m(!1)})},v=()=>{m(!1)},q=[{title:"序号",dataIndex:"id",width:60,render(e,s,o){return s.id==-1&&console.log(e,s.id),o+1}},{title:"场地名称",dataIndex:"venue_name",render:(e,s)=>t.jsx(L,{to:`/venue/detail/${s.id}`,className:"text-blue-500 hover:underline",children:e}),sorter:(e,s)=>e.venue_name.localeCompare(s.venue_name)},{title:"场地代码",dataIndex:"venue_code",sorter:(e,s)=>(e.venue_code||"").localeCompare(s.venue_code||"")},{title:"所在国家",dataIndex:"country",sorter:(e,s)=>(e.country||"").localeCompare(s.country||"")},{title:"托管机器",dataIndex:"hosted_machine",width:100},{title:"机型",dataIndex:"miner_type",width:100},{title:"场地键值",dataIndex:"agent_key",width:300},{title:"详细地址",dataIndex:"address",width:200},{title:"操作",key:"action",width:120,render:(e,s)=>t.jsxs(H,{size:"middle",children:[t.jsx(c,{type:"text",icon:t.jsx(X,{}),onClick:()=>R(s)}),t.jsx(c,{type:"text",icon:t.jsx(Y,{}),onClick:()=>O(s.id)})]})}],y=Array.from(new Set(u.map(e=>e!=null&&e.country?e.country:null).filter(Boolean)));return t.jsxs("div",{className:"p-6 bg-white rounded-lg shadow-sm",children:[t.jsxs("div",{className:"flex justify-between items-center mb-6 filter-form",children:[t.jsx("div",{className:"flex space-x-4",children:t.jsx(c,{type:"primary",size:"middle",icon:t.jsx(J,{}),onClick:A,className:"!rounded-button whitespace-nowrap",children:"新增场地"})}),t.jsxs("div",{className:"flex space-x-4",children:[t.jsx(r,{size:"middle",placeholder:"搜索场地名称、代码或地址",prefix:t.jsx(P,{}),onChange:e=>E(e.target.value),className:"w-64"}),t.jsx(S,{size:"middle",placeholder:"按国家筛选",allowClear:!0,onChange:T,className:"w-40",children:y==null?void 0:y.map(e=>t.jsx(ee,{value:e,children:e},e))})]})]}),t.jsx(W,{columns:q,dataSource:k,rowKey:"id",scroll:{x:"max-content"},pagination:{pageSize:z,showSizeChanger:!0,onShowSizeChange:e=>{$(e)},showQuickJumper:!0,showTotal:e=>`共 ${e} 条`}}),t.jsx(I,{title:x?"编辑场地":"新增场地",visible:N,onOk:w,onCancel:v,width:600,footer:[t.jsx(c,{onClick:v,children:"取消"},"back"),t.jsx(c,{type:"primary",onClick:w,children:"确定"},"submit")],children:t.jsxs(n,{form:h,layout:"vertical",initialValues:x||void 0,children:[t.jsx(n.Item,{name:"venue_name",label:"场地名称",rules:[{required:!0,message:"请输入场地名称"}],children:t.jsx(r,{placeholder:"请输入场地名称"})}),t.jsx(n.Item,{name:"venue_code",label:"场地代码",children:t.jsx(r,{placeholder:"请输入场地代码"})}),t.jsx(n.Item,{name:"country",label:"所在国家",rules:[{required:!0,message:"请输入国家"},{whitespace:!0,message:"国家不能为空"}],children:t.jsx(r,{placeholder:"请输入国家"})}),t.jsx(n.Item,{name:"hosted_machine",label:"托管机器",children:t.jsx(r,{type:"number",placeholder:"托管机器"})}),t.jsx(n.Item,{name:"miner_type",label:"托管机型",children:t.jsx(r,{placeholder:"托管机型"})}),t.jsx(n.Item,{name:"agent_key",label:"场地键值",children:t.jsx(r,{placeholder:"agent_key"})}),t.jsx(n.Item,{name:"address",label:"详细地址",children:t.jsx(Z,{rows:3,placeholder:"请输入详细地址"})}),t.jsx(n.Item,{name:"id",label:"场地ID",style:{display:"none"},children:t.jsx(r,{type:"hidden"})})]})})]})};export{ce as default};
