var ne=Object.defineProperty,re=Object.defineProperties;var oe=Object.getOwnPropertyDescriptors;var q=Object.getOwnPropertySymbols;var ie=Object.prototype.hasOwnProperty,le=Object.prototype.propertyIsEnumerable;var U=(o,a,n)=>a in o?ne(o,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[a]=n,$=(o,a)=>{for(var n in a||(a={}))ie.call(a,n)&&U(o,n,a[n]);if(q)for(var n of q(a))le.call(a,n)&&U(o,n,a[n]);return o},C=(o,a)=>re(o,oe(a));var L=(o,a,n)=>new Promise((d,p)=>{var h=c=>{try{r(n.next(c))}catch(x){p(x)}},f=c=>{try{r(n.throw(c))}catch(x){p(x)}},r=c=>c.done?d(c.value):Promise.resolve(c.value).then(h,f);r((n=n.apply(o,a)).next())});import{j as t,a as de,b as ce,g as ue}from"./index-C0GXfMyf.js";import{e as me,g as pe,r as g}from"./react-BIszHAjf.js";import{bg as he,B as w,bh as xe,K as _,d as l,F as m,a5 as _e,I as b,Q as fe,q as T,G as V,a2 as O,be as ge,W as je,a3 as ye,Z as z,z as H,U as P,bi as we,a1 as ve}from"./antd-CcxI5lPu.js";import{c as Se}from"./fetchHelper-CC9xOX0l.js";import{a as be,u as Ie,b as De,c as Te,d as ze}from"./hook-DvEEmdZK.js";import"./useQuery-BPbyEatn.js";import"./useMutation-CHmZSBV2.js";import"./api-DHPRkJq7.js";var G={exports:{}};(function(o,a){(function(n,d){o.exports=d()})(me,function(){return function(n,d,p){d.prototype.isBetween=function(h,f,r,c){var x=p(h),y=p(f),v=(c=c||"()")[0]==="(",I=c[1]===")";return(v?this.isAfter(x,r):!this.isBefore(x,r))&&(I?this.isBefore(y,r):!this.isAfter(y,r))||(v?this.isBefore(x,r):!this.isAfter(x,r))&&(I?this.isAfter(y,r):!this.isBefore(y,r))}}})})(G);var ke=G.exports;const Ne=pe(ke),Re=()=>{const[o,a]=g.useState(!1),n={name:"file",accept:".xlsx,.xls",showUploadList:!1,customRequest:d=>L(void 0,null,function*(){const{file:p}=d,h=new FormData;h.append("file",p);try{const f=localStorage.getItem("access_token");a(!0);const r=yield Se.post("https://datastring.cc/admin-api/event/import",h,{headers:{"Content-Type":"multipart/form-data",Authorization:`Bearer ${f}`}});return _.success("上传成功"),r.data}catch(f){throw _.error("上传失败"),f}finally{a(!1)}})};return t.jsx(he,C($({},n),{children:t.jsx(w,{icon:t.jsx(xe,{}),size:"middle",loading:o,children:"导入事件"})}))};l.extend(Ne);const{RangePicker:Ee}=z,{Option:Y}=T,{TextArea:K}=b,Oe=()=>{var M,B,A;const[o,a]=g.useState(!1),[n]=g.useState([]),[d]=m.useForm(),{poolType:p}=de(ce(["poolType"])),{data:h,isLoading:f}=be(p),{data:r}=Ie(p),c=De(),x=Te(),y=ze(),[v,I]=g.useState(""),[k,J]=g.useState([]),[N,Q]=g.useState([]),[R,W]=g.useState(""),[j,X]=g.useState([null,null]),E=(((M=h==null?void 0:h.data)==null?void 0:M.map((e,s)=>({key:s+1,id:e.id,venue_id:e.venue_id,venue_name:e.venue_info.venue_name,log_date:e.log_date,start_time:e.start_time,end_time:e.end_time,log_type:e.log_type,impact_count:e.impact_count,impact_power_loss:e.impact_power_loss,event_reason:e.event_reason,resolution_measures:e.resolution_measures,created_at:e.created_at})))||[]).filter(e=>{const s=k.length?k.includes(e.venue_name):!0,i=N.length?N.includes(e.log_type):!0,S=e.event_reason.includes(R)||e.resolution_measures.includes(R),u=Array.isArray(j)&&j.length===2&&j[0]&&j[1]?l(e.log_date).isBetween(j[0],j[1],null,"[]"):!0,F=e.start_time&&e.end_time;return s&&i&&S&&u&&(v==="valid"?F:v==="empty"?!F:!0)}),Z=[{title:"序号",dataIndex:"key",width:"70px",rowScope:"row",render(e,s,i){return i===-1&&console.log(e,s.key),i+1}},{title:"场地",dataIndex:"venue_name",width:200,render:e=>{const s=e==="Arct-HF01-J XP-AR-US";return t.jsx(H,{title:e,placement:"top",overlayInnerStyle:{color:"white"},style:{color:"white"},children:t.jsxs("div",{style:{width:"100%",overflow:"hidden",color:s?"red":"#333",textOverflow:"ellipsis",whiteSpace:"nowrap",fontWeight:s?"bold":"normal"},children:[e,s&&t.jsx(P,{color:"red",style:{marginLeft:2},children:"补充"})]})})}},{title:"影响时长",dataIndex:"log_date",width:120,filters:[{text:"未结束事件",value:"empty"},{text:"已结束事件",value:"valid"}],onFilter:(e,s)=>{I(e);const i=s.start_time&&s.end_time;return e==="valid"?i:e==="empty"?!i:!0},render:(e,s)=>(e==="---valid---"&&console.log(e),s.start_time&&s.end_time?ue(s.start_time,s.end_time):"---"),sorter:(e,s)=>{const i=e.start_time&&e.end_time?l(e.end_time).diff(l(e.start_time),"second"):0,S=s.start_time&&s.end_time?l(s.end_time).diff(l(s.start_time),"second"):0;return i-S}},{title:"时间范围",dataIndex:"start_time",width:280,render:(e,s)=>`${s.start_time} - ${s.end_time}`,sorter:(e,s)=>l(e.log_date).unix()-l(s.log_date).unix(),defaultSortOrder:"descend"},{title:"事件类型",dataIndex:"log_type",width:120,filters:[{text:"电力",value:"电力"},{text:"高温",value:"高温"},{text:"极端天气",value:"极端天气"},{text:"日常维护",value:"日常维护"},{text:"设备故障",value:"设备故障"},{text:"网络",value:"网络"},{text:"限电",value:"限电"}],onFilter:()=>!0,render:e=>{const s={限电:"red",设备故障:"orange",电力:"cyan",高温:"blue",极端天气:"magenta",日常维护:"green",网络:"geekblue",其他:"default"};return t.jsx(P,{color:s[e],children:e})}},{title:"影响台数",dataIndex:"impact_count",width:105,sorter:(e,s)=>e.impact_count-s.impact_count},{title:"影响算力",dataIndex:"impact_power_loss",width:120,render:e=>{if(e)return`${e} T`}},{title:"事件原因",dataIndex:"event_reason",width:250,ellipsis:!0,render:e=>t.jsx(H,{title:e,placement:"top",overlayInnerStyle:{color:"white"},style:{color:"white"},children:t.jsx("div",{style:{width:"100%",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:e})})},{title:"解决措施",dataIndex:"resolution_measures",width:200,ellipsis:!0},{title:"操作",key:"action",width:120,fixed:"right",render:(e,s)=>t.jsxs(V,{size:"middle",children:[t.jsx(w,{type:"text",icon:t.jsx(we,{}),onClick:()=>te(s),className:"!rounded-button"}),t.jsx(ve,{title:"确定要删除这条记录吗？",onConfirm:()=>se(s.id),okText:"确定",cancelText:"取消",children:t.jsx(w,{type:"text",icon:t.jsx(O,{}),className:"!rounded-button"})})]})}];g.useEffect(()=>{},[f,N]);const ee=()=>{d.resetFields(),a(!0)},te=e=>{d.setFieldsValue(C($({},e),{log_date:e.log_date?l(e.log_date):void 0,start_time:e.start_time?l(e.start_time):void 0,end_time:e.end_time?l(e.end_time):void 0})),a(!0)},se=e=>{y.mutate(e,{onSuccess:()=>{_.success("删除成功")},onError:s=>{_.error(`删除失败: ${s.message}`)}})},ae=()=>{d.validateFields().then(e=>{const s={id:e.id,venue_id:e.venue_id,log_date:l(e.log_date).format("YYYY-MM-DD"),start_time:l(e.start_time).format("YYYY-MM-DD HH:mm"),end_time:l(e.end_time).format("YYYY-MM-DD HH:mm"),log_type:e.log_type,impact_count:parseInt(e.impact_count,10),impact_power_loss:Number(e.impact_power_loss),event_reason:e.event_reason,resolution_measures:e.resolution_measures};e.id!==void 0?x.mutate(s,{onSuccess:()=>{_.success("更新成功")},onError:i=>{_.error(`更新失败: ${i.message}`)}}):c.mutate({poolType:p,data:s},{onSuccess:()=>{_.success("添加成功")},onError:i=>{_.error(`添加失败: ${i.message}`)}}),a(!1)})};return t.jsxs("div",{className:"bg-gray-50 p-6",children:[t.jsxs("div",{className:"mx-auto bg-white rounded-lg shadow-sm",children:[t.jsxs("div",{className:"p-6 border-b border-gray-200",children:[t.jsxs("div",{className:"grid grid-cols-[auto_1fr] gap-6 mb-6 filter-form",children:[t.jsx(w,{type:"primary",icon:t.jsx(_e,{}),onClick:ee,size:"middle",className:"!rounded-button",children:"新增事件"}),t.jsxs("div",{className:"flex items-center justify-end gap-4",children:[t.jsx(b,{placeholder:"搜索事件内容",prefix:t.jsx(fe,{}),size:"middle",className:"max-w-xs !rounded-lg",value:R,onChange:e=>W(e.target.value)}),t.jsx(Ee,{size:"middle",className:"!rounded-lg",placeholder:["开始日期","结束日期"],value:j,onChange:()=>X}),t.jsx(T,{mode:"multiple",maxTagCount:"responsive",maxTagTextLength:4,size:"middle",placeholder:"选择场地",value:k,onChange:J,style:{width:150},children:(B=r==null?void 0:r.data)==null?void 0:B.map(e=>t.jsx(Y,{value:e.venue_name,children:e.venue_name},e.id))})]})]}),t.jsx("div",{className:"flex items-center gap-4 mb-6",children:t.jsxs(V,{children:[n.length>0&&t.jsx(w,{danger:!0,icon:t.jsx(O,{}),onClick:()=>_.success("批量删除成功"),className:"!rounded-button",children:"批量删除"}),t.jsx(Re,{}),t.jsx(w,{icon:t.jsx(ge,{}),size:"middle",onClick:()=>{const e=["场地","日期","时间范围","事件类型","影响台数","事件原因","解决措施","记录人","记录时间"],s=E.map(u=>[u.venue_name,u.log_date,`${u.start_time} - ${u.end_time}`,u.log_type,u.impact_count,u.event_reason,u.resolution_measures,u.created_at]),i=[e,...s].map(u=>u.join(",")).join(`
`),S=new Blob([i],{type:"text/csv;charset=utf-8;"}),D=document.createElement("a");D.href=URL.createObjectURL(S),D.download=`事件日志_${l().format("YYYY-MM-DD")}.csv`,D.click(),_.success("导出成功")},className:"!rounded-button",children:"导出事件"})]})})]}),t.jsx(je,{columns:Z,dataSource:E,scroll:{x:1300},rowKey:"id",onChange:(e,s)=>{Q(s.log_type||[])},pagination:{total:E.length,pageSize:10,showSizeChanger:!0,showQuickJumper:!0,showTotal:e=>`共 ${e} 条记录`}})]}),t.jsx(ye,{title:d.getFieldValue("id")?"编辑事件":"新增事件",open:o,onOk:ae,onCancel:()=>a(!1),width:800,okText:"确定",cancelText:"取消",children:t.jsxs(m,{form:d,layout:"vertical",className:"pt-4",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-x-6",children:[t.jsx(m.Item,{name:"id",style:{display:"none"},children:t.jsx(b,{type:"hidden"})}),t.jsx(m.Item,{name:"venue_id",label:"场地",rules:[{required:!0,message:"请选择场地"}],children:t.jsx(T,{placeholder:"请选择场地",allowClear:!0,style:{width:"100%",fontSize:"12px"},children:(A=r==null?void 0:r.data)==null?void 0:A.map(e=>t.jsx(Y,{value:e.id,style:{fontSize:"12px"},children:e.venue_name},e.id))})}),t.jsx(m.Item,{name:"log_date",label:"日期",rules:[{required:!0,message:"请选择日期"}],children:t.jsx(z,{className:"w-full"})}),t.jsx(m.Item,{name:"start_time",label:"开始时间",rules:[{required:!0,message:"请选择开始时间"}],children:t.jsx(z,{showTime:!0,className:"w-full"})}),t.jsx(m.Item,{name:"end_time",label:"结束时间",rules:[{required:!0,message:"请选择结束时间"}],children:t.jsx(z,{showTime:!0,className:"w-full"})}),t.jsx(m.Item,{name:"log_type",label:"事件类型",rules:[{required:!0,message:"请选择事件类型"}],children:t.jsx(T,{placeholder:"请选择事件类型",children:["电力","高温","极端天气","日常维护","设备故障","限电"].map(e=>t.jsx(Y,{value:e,children:e},e))})}),t.jsx(m.Item,{name:"impact_count",label:"影响台数",style:{fontSize:"12px"},rules:[{required:!0,message:"请输入影响台数"}],children:t.jsx(b,{type:"number",placeholder:"请输入影响台数",style:{fontSize:"12px"}})}),t.jsx(m.Item,{name:"impact_power_loss",label:"影响算力",style:{fontSize:"12px"},rules:[{required:!0,message:"请输入影响算力"}],children:t.jsx(b,{type:"number",placeholder:"请输入影响算力",style:{fontSize:"12px"}})})]}),t.jsx(m.Item,{name:"event_reason",label:"事件原因",style:{fontSize:"12px"},rules:[{required:!0,message:"请输入事件原因"}],children:t.jsx(K,{rows:4,placeholder:"请输入事件原因",style:{fontSize:"12px"}})}),t.jsx(m.Item,{name:"resolution_measures",label:"解决措施",style:{fontSize:"12px"},rules:[{required:!0,message:"请输入解决措施"}],children:t.jsx(K,{rows:4,placeholder:"请输入解决措施",style:{fontSize:"12px"}})})]})})]})};export{Oe as default};
