import{a as B,b as D,j as t}from"./index-B9bs-ISz.js";import{r as a}from"./react-BIszHAjf.js";import{u as K}from"./useAuthRedirect-BhFCZHSR.js";import{u as Q,e as U,f as G}from"./hook-l2gPxssQ.js";import{F as n,K as l,B as i,a5 as J,I as r,Q as L,q as S,W as P,a3 as v,G as W,bn as H,a2 as X}from"./antd-DyiLpPLO.js";import"./fetchHelper-RfII1d93.js";import"./useQuery-D_zpbqkF.js";import"./useMutation-CH1Cq_qu.js";import"./api-VnLgEFPt.js";const{TextArea:Y}=r,{Option:Z}=S,ce=()=>{K();const{poolType:_}=B(D(["poolType"])),{data:d}=Q(_),[u,f]=a.useState([]),[k,j]=a.useState([]),[c,C]=a.useState(""),[p,V]=a.useState(null),[N,m]=a.useState(!1),[x,g]=a.useState(null),[h]=n.useForm(),F=U(),M=G(),[z,E]=a.useState(20);a.useEffect(()=>{if(d)if(Array.isArray(d.data)){const e=d.data.map(s=>({id:s.id,venue_type:s.venue_type,venue_name:s.venue_name,venue_code:s.venue_code,country:s.country,address:s.address,agent_key:s.agent_key,hosted_machine:s.hosted_machine,miner_type:s.miner_type}));f(e),j(e)}else l.error(`获取场地数据失败: ${d.data.message}`)},[d]),a.useEffect(()=>{let e=u;c&&(e=e.filter(s=>{var o,b;return s.venue_name.includes(c)||((o=s.venue_code)==null?void 0:o.includes(c))||((b=s.address)==null?void 0:b.includes(c))})),p&&(e=e.filter(s=>s.country===p)),j(e)},[c,p,u]);const T=e=>{C(e)},$=e=>{V(e||null)},A=()=>{g(null),h.resetFields(),m(!0)},R=e=>{g(e),h.setFieldsValue(e),m(!0)},O=e=>{v.confirm({title:"确认删除",content:"确定要删除这个场地吗？",onOk:()=>{f(u.filter(s=>s.id!==e)),l.success("删除成功")}})},w=()=>{h.validateFields().then(e=>{if(x){const s=Number(e.hosted_machine);if(isNaN(s)){l.error("hosted_machine 不是有效的数字");return}e.hosted_machine=s,M.mutate(e,{onSuccess:()=>{l.success("更新成功")},onError:o=>{l.error(`更新失败: ${o.message}`)}})}else{const s={id:0,venue_name:e.venue_name,venue_code:e.venue_code,country:e.country,address:e.address,agent_key:e.agent_key,hosted_machine:Number(e.hosted_machine),miner_type:e.miner_type};F.mutate({poolType:_,data:s},{onSuccess:()=>{l.success("创建成功")},onError:o=>{l.error(`创建失败: ${o.message}`)}})}m(!1)})},I=()=>{m(!1)},q=[{title:"序号",dataIndex:"id",width:60,render(e,s,o){return s.id==-1&&console.log(e,s.id),o+1}},{title:"场地名称",dataIndex:"venue_name",sorter:(e,s)=>e.venue_name.localeCompare(s.venue_name)},{title:"场地代码",dataIndex:"venue_code",sorter:(e,s)=>(e.venue_code||"").localeCompare(s.venue_code||"")},{title:"所在国家",dataIndex:"country",sorter:(e,s)=>(e.country||"").localeCompare(s.country||"")},{title:"托管机器",dataIndex:"hosted_machine",width:100},{title:"机型",dataIndex:"miner_type",width:100},{title:"场地键值",dataIndex:"agent_key",width:300},{title:"详细地址",dataIndex:"address",width:200},{title:"操作",key:"action",width:120,render:(e,s)=>t.jsxs(W,{size:"middle",children:[t.jsx(i,{type:"text",icon:t.jsx(H,{}),onClick:()=>R(s)}),t.jsx(i,{type:"text",icon:t.jsx(X,{}),onClick:()=>O(s.id)})]})}],y=Array.from(new Set(u.map(e=>e!=null&&e.country?e.country:null).filter(Boolean)));return t.jsxs("div",{className:"p-6 bg-white rounded-lg shadow-sm",children:[t.jsxs("div",{className:"flex justify-between items-center mb-6 filter-form",children:[t.jsx("div",{className:"flex space-x-4",children:t.jsx(i,{type:"primary",size:"middle",icon:t.jsx(J,{}),onClick:A,className:"!rounded-button whitespace-nowrap",children:"新增场地"})}),t.jsxs("div",{className:"flex space-x-4",children:[t.jsx(r,{size:"middle",placeholder:"搜索场地名称、代码或地址",prefix:t.jsx(L,{}),onChange:e=>T(e.target.value),className:"w-64"}),t.jsx(S,{size:"middle",placeholder:"按国家筛选",allowClear:!0,onChange:$,className:"w-40",children:y==null?void 0:y.map(e=>t.jsx(Z,{value:e,children:e},e))})]})]}),t.jsx(P,{columns:q,dataSource:k,rowKey:"id",scroll:{x:"max-content"},pagination:{pageSize:z,showSizeChanger:!0,onShowSizeChange:e=>{E(e)},showQuickJumper:!0,showTotal:e=>`共 ${e} 条`}}),t.jsx(v,{title:x?"编辑场地":"新增场地",visible:N,onOk:w,onCancel:I,width:600,footer:[t.jsx(i,{onClick:I,children:"取消"},"back"),t.jsx(i,{type:"primary",onClick:w,children:"确定"},"submit")],children:t.jsxs(n,{form:h,layout:"vertical",initialValues:x||void 0,children:[t.jsx(n.Item,{name:"venue_name",label:"场地名称",rules:[{required:!0,message:"请输入场地名称"}],children:t.jsx(r,{placeholder:"请输入场地名称"})}),t.jsx(n.Item,{name:"venue_code",label:"场地代码",children:t.jsx(r,{placeholder:"请输入场地代码"})}),t.jsx(n.Item,{name:"country",label:"所在国家",rules:[{required:!0,message:"请输入国家"},{whitespace:!0,message:"国家不能为空"}],children:t.jsx(r,{placeholder:"请输入国家"})}),t.jsx(n.Item,{name:"hosted_machine",label:"托管机器",children:t.jsx(r,{type:"number",placeholder:"托管机器"})}),t.jsx(n.Item,{name:"miner_type",label:"托管机型",children:t.jsx(r,{placeholder:"托管机型"})}),t.jsx(n.Item,{name:"agent_key",label:"场地键值",children:t.jsx(r,{placeholder:"agent_key"})}),t.jsx(n.Item,{name:"address",label:"详细地址",children:t.jsx(Y,{rows:3,placeholder:"请输入详细地址"})}),t.jsx(n.Item,{name:"id",label:"场地ID",style:{display:"none"},children:t.jsx(r,{type:"hidden"})})]})})]})};export{ce as default};
