var W=Object.defineProperty,Z=Object.defineProperties;var X=Object.getOwnPropertyDescriptors;var T=Object.getOwnPropertySymbols;var ee=Object.prototype.hasOwnProperty,te=Object.prototype.propertyIsEnumerable;var Y=(d,a,l)=>a in d?W(d,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):d[a]=l,k=(d,a)=>{for(var l in a||(a={}))ee.call(a,l)&&Y(d,l,a[l]);if(T)for(var l of T(a))te.call(a,l)&&Y(d,l,a[l]);return d},M=(d,a)=>Z(d,X(a));import{a as se,b as ae,j as t,g as ne}from"./index-D5n0M57a.js";import{r as m,m as re}from"./react-BIszHAjf.js";import{d as r,F as i,B as h,a5 as oe,I as _,Q as le,G as z,a2 as E,K as u,be as ie,W as de,a3 as ce,Z as f,q as $,U as ue,z as me,bl as pe,a1 as _e}from"./antd-BlFR_sXc.js";import{i as xe,U as he}from"./UploadExcel-CMfihBOU.js";import{g as ge,b as fe,c as je,d as ve}from"./hook-CAn5Ho5_.js";import"./fetchHelper-B3ZRhvca.js";import"./useQuery-DVC4-15e.js";import"./useMutation-C8QgCO9i.js";import"./api-iBWBavoU.js";r.extend(xe);const{RangePicker:ye}=f,{Option:we}=$,{TextArea:R}=_,$e=()=>{var N;const[d,a]=m.useState(!1),[l]=m.useState([]),[p]=i.useForm(),{poolType:C}=se(ae(["poolType"])),S=re(),j=S.venueId,F=S.venueName,{data:v,isLoading:I}=ge(Number(j)),q=fe(),U=je(),V=ve(),[D,A]=m.useState(""),[y,B]=m.useState([]),[w,O]=m.useState(""),[c,L]=m.useState(null),b=(((N=v==null?void 0:v.data)==null?void 0:N.map((e,s)=>({key:s+1,id:e.id,venue_id:e.venue_id,venue_name:e.venue_info.venue_name,log_date:e.log_date,start_time:e.start_time,end_time:e.end_time,log_type:e.log_type,impact_count:e.impact_count,impact_power_loss:e.impact_power_loss,event_reason:e.event_reason,resolution_measures:e.resolution_measures,created_at:e.created_at})))||[]).filter(e=>{const s=y.length?y.includes(e.log_type):!0,n=e.event_reason.includes(w)||e.resolution_measures.includes(w),x=Array.isArray(c)&&c.length===2&&c[0]&&c[1]?r(e.log_date).isBetween(c[0],c[1],null,"[]"):!0,o=e.start_time&&e.end_time;return s&&n&&x&&(D==="valid"?o:D==="empty"?!o:!0)}),H=[{title:"序号",dataIndex:"key",width:"70px",rowScope:"row",render(e,s,n){return n===-1&&console.log(e,s.key),n+1}},{title:"日期",dataIndex:"log_date",width:"145px",rowScope:"row"},{title:"影响时长",dataIndex:"log_date",width:120,filters:[{text:"未结束事件",value:"empty"},{text:"已结束事件",value:"valid"}],onFilter:(e,s)=>{A(e);const n=s.start_time&&s.end_time;return e==="valid"?n:e==="empty"?!n:!0},render:(e,s)=>(e==="---valid---"&&console.log(e),s.start_time&&s.end_time?ne(s.start_time,s.end_time):"---"),sorter:(e,s)=>{const n=e.start_time&&e.end_time?r(e.end_time).diff(r(e.start_time),"second"):0,g=s.start_time&&s.end_time?r(s.end_time).diff(r(s.start_time),"second"):0;return n-g}},{title:"时间范围",dataIndex:"start_time",width:280,render:(e,s)=>`${s.start_time} - ${s.end_time}`,sorter:(e,s)=>r(e.log_date).unix()-r(s.log_date).unix(),defaultSortOrder:"descend"},{title:"事件类型",dataIndex:"log_type",width:120,filters:[{text:"电力",value:"电力"},{text:"高温",value:"高温"},{text:"极端天气",value:"极端天气"},{text:"日常维护",value:"日常维护"},{text:"设备故障",value:"设备故障"},{text:"网络",value:"网络"},{text:"限电",value:"限电"}],onFilter:()=>!0,render:e=>{const s={限电:"red",设备故障:"orange",电力:"cyan",高温:"blue",极端天气:"magenta",日常维护:"green",网络:"geekblue",其他:"default"};return t.jsx(ue,{color:s[e],children:e})}},{title:"影响台数",dataIndex:"impact_count",width:105,sorter:(e,s)=>e.impact_count-s.impact_count},{title:"影响算力",dataIndex:"impact_power_loss",width:120,render:e=>{if(e)return`${e} T`}},{title:"事件原因",dataIndex:"event_reason",width:250,ellipsis:!0,render:e=>t.jsx(me,{title:e,placement:"top",overlayInnerStyle:{color:"white"},style:{color:"white"},children:t.jsx("div",{style:{width:"100%",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:e})})},{title:"解决措施",dataIndex:"resolution_measures",width:200,ellipsis:!0},{title:"操作",key:"action",width:120,fixed:"right",render:(e,s)=>t.jsxs(z,{size:"middle",children:[t.jsx(h,{type:"text",icon:t.jsx(pe,{}),onClick:()=>K(s),className:"!rounded-button"}),t.jsx(_e,{title:"确定要删除这条记录吗？",onConfirm:()=>Q(s.id),okText:"确定",cancelText:"取消",children:t.jsx(h,{type:"text",icon:t.jsx(E,{}),className:"!rounded-button"})})]})}];m.useEffect(()=>{},[I,y,c]);const P=()=>{p.resetFields(),p.setFieldsValue({venue_id:j}),a(!0)},K=e=>{p.setFieldsValue(M(k({},e),{log_date:e.log_date?r(e.log_date):void 0,start_time:e.start_time?r(e.start_time):void 0,end_time:e.end_time?r(e.end_time):void 0})),a(!0)},Q=e=>{V.mutate(e,{onSuccess:()=>{u.success("删除成功")},onError:s=>{u.error(`删除失败: ${s.message}`)}})},G=()=>{p.validateFields().then(e=>{const s={id:e.id,venue_id:e.venue_id,log_date:r(e.log_date).format("YYYY-MM-DD"),start_time:r(e.start_time).format("YYYY-MM-DD HH:mm"),end_time:r(e.end_time).format("YYYY-MM-DD HH:mm"),log_type:e.log_type,impact_count:parseInt(e.impact_count,10),impact_power_loss:Number(e.impact_power_loss),event_reason:e.event_reason,resolution_measures:e.resolution_measures};e.id!==void 0?U.mutate(s,{onSuccess:()=>{u.success("更新成功")},onError:n=>{u.error(`更新失败: ${n.message}`)}}):q.mutate({poolType:C,data:s},{onSuccess:()=>{u.success("添加成功")},onError:n=>{u.error(`添加失败: ${n.message}`)}}),a(!1)})},J=(e,s)=>{console.log("原始 Dayjs 对象:",e),console.log("格式化字符串:",s),L(e)};return t.jsxs("div",{className:"",children:[t.jsx("header",{className:"mb-0",children:t.jsx("div",{className:"flex items-center gap-4 mb-3",children:t.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:F})})}),t.jsxs("div",{className:"mx-auto bg-white rounded-lg shadow-sm",children:[t.jsxs("div",{className:"p-6 border-b border-gray-200",children:[t.jsxs("div",{className:"grid grid-cols-[auto_1fr] gap-6 mb-6 filter-form",children:[t.jsx(h,{type:"primary",icon:t.jsx(oe,{}),onClick:P,size:"middle",className:"!rounded-button",children:"新增事件"}),t.jsxs("div",{className:"flex items-center justify-end gap-4",children:[t.jsx(_,{placeholder:"搜索事件内容",prefix:t.jsx(le,{}),size:"middle",className:"max-w-xs !rounded-lg",value:w,onChange:e=>O(e.target.value)}),t.jsx(ye,{size:"middle",className:"!rounded-lg",placeholder:["开始日期","结束日期"],value:c,format:"YYYY-MM-DD",onChange:()=>J})]})]}),t.jsx("div",{className:"flex items-center gap-4 mb-6",children:t.jsxs(z,{children:[l.length>0&&t.jsx(h,{danger:!0,icon:t.jsx(E,{}),onClick:()=>u.success("批量删除成功"),className:"!rounded-button",children:"批量删除"}),t.jsx(he,{}),t.jsx(h,{icon:t.jsx(ie,{}),size:"middle",onClick:()=>{const e=["场地","日期","时间范围","事件类型","影响台数","事件原因","解决措施","记录人","记录时间"],s=b.map(o=>[o.venue_name,o.log_date,`${o.start_time} - ${o.end_time}`,o.log_type,o.impact_count,o.event_reason,o.resolution_measures,o.created_at]),n=[e,...s].map(o=>o.join(",")).join(`
`),g=new Blob([n],{type:"text/csv;charset=utf-8;"}),x=document.createElement("a");x.href=URL.createObjectURL(g),x.download=`事件日志_${r().format("YYYY-MM-DD")}.csv`,x.click(),u.success("导出成功")},className:"!rounded-button",children:"导出事件"})]})})]}),t.jsx(de,{loading:I,columns:H,dataSource:b,scroll:{x:1300},rowKey:"id",onChange:(e,s)=>{B(s.log_type||[])},pagination:{total:b.length,pageSize:10,showSizeChanger:!0,showQuickJumper:!0,showTotal:e=>`共 ${e} 条记录`}})]}),t.jsx(ce,{title:p.getFieldValue("id")?"编辑事件":"新增事件",open:d,onOk:G,onCancel:()=>a(!1),width:800,okText:"确定",cancelText:"取消",children:t.jsxs(i,{form:p,layout:"vertical",className:"pt-4",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-x-6",children:[t.jsx(i.Item,{name:"id",style:{display:"none"},children:t.jsx(_,{type:"hidden"})}),t.jsx(i.Item,{name:"venue_id",label:"场地编号",rules:[{required:!0,message:"请选择场地"}],children:t.jsx(_,{value:j,disabled:!0})}),t.jsx(i.Item,{name:"log_date",label:"日期",rules:[{required:!0,message:"请选择日期"}],children:t.jsx(f,{className:"w-full"})}),t.jsx(i.Item,{name:"start_time",label:"开始时间",rules:[{required:!0,message:"请选择开始时间"}],children:t.jsx(f,{showTime:!0,className:"w-full"})}),t.jsx(i.Item,{name:"end_time",label:"结束时间",rules:[{required:!0,message:"请选择结束时间"}],children:t.jsx(f,{showTime:!0,className:"w-full"})}),t.jsx(i.Item,{name:"log_type",label:"事件类型",rules:[{required:!0,message:"请选择事件类型"}],children:t.jsx($,{placeholder:"请选择事件类型",children:["电力","高温","极端天气","日常维护","设备故障","限电"].map(e=>t.jsx(we,{value:e,children:e},e))})}),t.jsx(i.Item,{name:"impact_count",label:"影响台数",style:{fontSize:"12px"},rules:[{required:!0,message:"请输入影响台数"}],children:t.jsx(_,{type:"number",placeholder:"请输入影响台数",style:{fontSize:"12px"}})}),t.jsx(i.Item,{name:"impact_power_loss",label:"影响算力",style:{fontSize:"12px"},rules:[{required:!0,message:"请输入影响算力"}],children:t.jsx(_,{type:"number",placeholder:"请输入影响算力",style:{fontSize:"12px"}})})]}),t.jsx(i.Item,{name:"event_reason",label:"事件原因",style:{fontSize:"12px"},rules:[{required:!0,message:"请输入事件原因"}],children:t.jsx(R,{rows:4,placeholder:"请输入事件原因",style:{fontSize:"12px"}})}),t.jsx(i.Item,{name:"resolution_measures",label:"解决措施",style:{fontSize:"12px"},rules:[{required:!0,message:"请输入解决措施"}],children:t.jsx(R,{rows:4,placeholder:"请输入解决措施",style:{fontSize:"12px"}})})]})})]})};export{$e as default};
